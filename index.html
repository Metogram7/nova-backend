<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nova ‚Äî Geli≈ümi≈ü Web Asistan</title>
<style>
  :root{
    --bg:#000;
    --accent:#00d4ff;
    --panel:#0e0e0f;
    --terminal:#111;
    --user:#b6ffb6;
    --nova:#cfe9ff;
    --muted:#9aa7b2;
    --radius:12px;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, "Courier New", monospace;color:var(--nova);-webkit-font-smoothing:antialiased}
  .app{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:18px;
    padding:18px;
    height:100vh;
    align-items:stretch;
  }

  /* left panel */
  .left{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    padding:16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    border:1px solid rgba(0,212,255,0.04);
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:300px;
  }

  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .avatar{
    width:68px;height:68px;border-radius:16px;background:linear-gradient(135deg,#00d4ff,#0050aa);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:#001;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 -6px 12px rgba(255,255,255,0.03);
  }
  .brand h1{margin:0;font-size:20px}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  .controls{
    display:flex;gap:8px;flex-wrap:wrap;
  }
  .btn{
    background:var(--accent);color:#000;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 12px rgba(0,0,0,0.4);
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,212,255,0.12)}
  .btn.warn{background:#ffb86b;color:#000}

  /* suggestions */
  .suggestions{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--glass);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}

  /* settings */
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.02)
  }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type=range]{width:100%}

  /* right area */
  .right{display:flex;flex-direction:column;gap:12px;height:100%}
  .visual{
    height:320px;border-radius:12px;background:radial-gradient(circle at 50% 35%, rgba(0,212,255,0.06), transparent 25%), linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.02)
  }
  canvas{max-width:100%;height:100%}

  .wave-center{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;
  }
  .big-title{font-size:46px;color:white;letter-spacing:1px}
  .subtitle{font-size:14px;color:var(--muted)}

  .terminal{
    flex:1;background:var(--terminal);border-radius:12px;padding:14px;overflow:auto;border:1px solid rgba(0,212,255,0.03);
    display:flex;flex-direction:column;gap:10px;font-size:17px;
  }
  .message{max-width:78%;padding:10px 14px;border-radius:12px}
  .msg-user{align-self:flex-end;background:linear-gradient(90deg, rgba(182,255,182,0.08), rgba(182,255,182,0.04));border:1px solid rgba(50,150,50,0.12);color:var(--user)}
  .msg-nova{align-self:flex-start;background:linear-gradient(90deg, rgba(207,233,255,0.04), rgba(207,233,255,0.02));border:1px solid rgba(0,212,255,0.06);color:var(--nova)}

  .input-row{display:flex;gap:8px;align-items:center;padding-top:6px}
  #chatField{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--nova);font-size:16px}
  .small{font-size:13px;color:var(--muted)}

  footer{font-size:12px;color:var(--muted);text-align:right;padding-right:6px}

  /* responsive */
  @media(max-width:980px){
    .app{grid-template-columns:1fr;grid-auto-rows:auto;padding:12px}
    .left{order:2}
    .right{order:1}
  }
</style>
</head>
<body>
<div class="app">
  <div class="left">
    <div class="brand">
      <div class="avatar">No</div>
      <div>
        <h1>Nova</h1>
        <p>Sesli + Yazƒ±lƒ± Web Asistan ‚Äî Metehan geli≈ütirdi</p>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="btnListen">üéôÔ∏è Dinle</button>
      <button class="btn ghost" id="btnStop">‚èπÔ∏è Durdur</button>
      <button class="btn ghost" id="btnChat">üí¨ Chat Ba≈ülat</button>
      <button class="btn ghost" id="btnClear">üßπ Temizle</button>
    </div>

    <div class="panel">
      <div class="small">Hƒ±zlƒ± √∂neriler</div>
      <div class="suggestions" id="chips">
        <div class="chip">Merhaba</div>
        <div class="chip">Sen kimsin?</div>
        <div class="chip">Bir ≈üaka yap</div>
        <div class="chip">Bug√ºn hava nasƒ±l?</div>
        <div class="chip">Nova</div>
      </div>
    </div>

    <div class="panel">
      <label>Ses Hƒ±zƒ±: <span id="rateVal">1.0</span></label>
      <input type="range" id="rate" min="0.6" max="1.6" step="0.05" value="1.0">
      <label>Pitch: <span id="pitchVal">1.0</span></label>
      <input type="range" id="pitch" min="0.5" max="2.0" step="0.05" value="1.0">
      <label>Tema</label>
      <select id="themeSelect">
        <option value="dark">Karanlƒ±k</option>
        <option value="light">A√ßƒ±k (√∂nizleme)</option>
      </select>
    </div>

    <div class="panel small">
      <div><strong>Backend URL:</strong></div>
      <input type="text" id="backendUrl" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--nova)" placeholder="http://127.0.0.1:5000/gemma">
      <div class="small" style="margin-top:8px">Backend varsa buraya deploy URL'sini yaz. Yoksa Nova yerelde √ßalƒ±≈üƒ±r (fallback).</div>
    </div>

    <footer>Nova ‚Ä¢ Hazƒ±r</footer>
  </div>

  <div class="right">
    <div class="visual">
      <canvas id="vis" width="900" height="320"></canvas>
      <div class="wave-center">
        <div class="big-title">NoVa</div>
        <div class="subtitle" id="statusText">Hazƒ±r ‚Äî s√∂yle bir ≈üey s√∂yle</div>
      </div>
    </div>

    <div class="terminal" id="terminal">
      <!-- mesajlar buraya gelecek -->
    </div>

    <div class="input-row panel">
      <input id="chatField" placeholder="Yazƒ±p Enter'a bas (Chat modu i√ßin)...">
      <button class="btn" id="sendBtn">G√∂nder</button>
      <div style="width:10px"></div>
      <div class="small" id="connStatus">Backend: <span id="backendStatus">Bilinmiyor</span></div>
    </div>
  </div>
</div>

<script>
/*
  Geli≈ümi≈ü tek dosyalƒ±k Nova frontend
  √ñzellikler:
  - Chat & Voice (dinle), stop, clear
  - Suggestions
  - LocalStorage history + ayarlar
  - Backend fetch (ayarlanabilir) + fallback
*/

const BACKEND_INPUT = document.getElementById('backendUrl');
const BACKEND_STATUS = document.getElementById('backendStatus');
const terminal = document.getElementById('terminal');
const vis = document.getElementById('vis');
const ctx = vis.getContext('2d');
const statusText = document.getElementById('statusText');
const chatField = document.getElementById('chatField');

let BACKEND_URL = localStorage.getItem('nova_backend') || 'http://127.0.0.1:5000/gemma';
BACKEND_INPUT.value = BACKEND_URL;
let useBackend = true;

let utter = null;
let speaking = false;
let waveValues = new Array(120).fill(0);
let animationId = null;
let chatMode = false;

// Voice settings
const rateControl = document.getElementById('rate');
const pitchControl = document.getElementById('pitch');
const rateVal = document.getElementById('rateVal');
const pitchVal = document.getElementById('pitchVal');
rateControl.value = localStorage.getItem('nova_rate') || 1.0;
pitchControl.value = localStorage.getItem('nova_pitch') || 1.0;
rateVal.textContent = rateControl.value;
pitchVal.textContent = pitchControl.value;

// theme
const themeSelect = document.getElementById('themeSelect');
themeSelect.value = localStorage.getItem('nova_theme') || 'dark';
applyTheme(themeSelect.value);

// load saved history
const saved = JSON.parse(localStorage.getItem('nova_history') || '[]');
saved.forEach(m => {
  const el = document.createElement('div');
  el.className = 'message ' + (m.from === 'user' ? 'msg-user' : 'msg-nova');
  el.innerText = (m.from === 'user' ? 'Sen: ' : 'Nova: ') + m.text;
  terminal.appendChild(el);
});
terminal.scrollTop = terminal.scrollHeight;

// local fallback responses
const fallbackResponses = [
  "Bunu tam anlayamadƒ±m, biraz daha a√ßƒ±klar mƒ±sƒ±n?",
  "G√ºzel soru! ≈ûu an √ßevrimdƒ±≈üƒ± olduƒüum i√ßin kƒ±sa cevap veriyorum.",
  "Eƒülenceli! Ama ≈üu an √ßevrimi√ßi olduƒüumda daha iyi anlatƒ±rƒ±m."
];

// UI elements
document.getElementById('btnListen').addEventListener('click', startListening);
document.getElementById('btnStop').addEventListener('click', stopSpeaking);
document.getElementById('btnChat').addEventListener('click', toggleChat);
document.getElementById('btnClear').addEventListener('click', clearHistory);
document.getElementById('sendBtn').addEventListener('click', sendChat);
BACKEND_INPUT.addEventListener('change', ()=> {
  BACKEND_URL = BACKEND_INPUT.value.trim();
  localStorage.setItem('nova_backend', BACKEND_URL);
  checkBackend();
});

// chips
document.querySelectorAll('.chip').forEach(c=>{
  c.addEventListener('click', ()=> {
    const txt = c.textContent.trim();
    addUserMessage(txt);
    processCommand(txt);
  });
});

// rate/pitch
rateControl.addEventListener('input', ()=> {
  rateVal.textContent = rateControl.value;
  localStorage.setItem('nova_rate', rateControl.value);
});
pitchControl.addEventListener('input', ()=> {
  pitchVal.textContent = pitchControl.value;
  localStorage.setItem('nova_pitch', pitchControl.value);
});

// theme
themeSelect.addEventListener('change', ()=> {
  applyTheme(themeSelect.value);
  localStorage.setItem('nova_theme', themeSelect.value);
});

chatField.addEventListener('keydown', (e)=> {
  if (e.key === 'Enter') sendChat();
});

// save message to localStorage
function persistMessage(from, text){
  const arr = JSON.parse(localStorage.getItem('nova_history') || '[]');
  arr.push({from, text, time:Date.now()});
  localStorage.setItem('nova_history', JSON.stringify(arr));
}

// add messages
function addUserMessage(text){
  const el = document.createElement('div');
  el.className = 'message msg-user';
  el.innerText = 'Sen: ' + text;
  terminal.appendChild(el);
  terminal.scrollTop = terminal.scrollHeight;
  persistMessage('user', text);
}
function addNovaMessage(text){
  const el = document.createElement('div');
  el.className = 'message msg-nova';
  el.innerText = 'Nova: ' + text;
  terminal.appendChild(el);
  terminal.scrollTop = terminal.scrollHeight;
  persistMessage('nova', text);
}

// clear history
function clearHistory(){
  if(!confirm('Terminal ge√ßmi≈üi temizlensin mi?')) return;
  localStorage.removeItem('nova_history');
  terminal.innerHTML = '';
  BACKEND_STATUS.innerText = 'Bilinmiyor';
}

// apply theme
function applyTheme(name){
  if(name === 'light'){
    document.documentElement.style.setProperty('--bg','#f4f7fb');
    document.documentElement.style.setProperty('--terminal','#ffffff');
    document.documentElement.style.setProperty('--panel','#ffffff');
    document.documentElement.style.setProperty('--nova','#0a2b3a');
    document.documentElement.style.setProperty('--muted','#6b7280');
    document.documentElement.style.setProperty('--accent','#0077ff');
  } else {
    document.documentElement.style.setProperty('--bg','#000');
    document.documentElement.style.setProperty('--terminal','#111');
    document.documentElement.style.setProperty('--panel','#0e0e0f');
    document.documentElement.style.setProperty('--nova','#cfe9ff');
    document.documentElement.style.setProperty('--muted','#9aa7b2');
    document.documentElement.style.setProperty('--accent','#00d4ff');
  }
}

// voice speak
function speak(text){
  if(utter) speechSynthesis.cancel();
  addNovaMessage(text);
  utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'tr-TR';
  utter.rate = parseFloat(rateControl.value || 1.0);
  utter.pitch = parseFloat(pitchControl.value || 1.0);
  utter.onend = ()=> { speaking = false; utter = null; statusText.innerText = 'Hazƒ±r ‚Äî s√∂yle bir ≈üey s√∂yle'; };
  utter.onerror = ()=> { speaking = false; utter = null; statusText.innerText = 'Hata: konu≈üma iptal'; };
  speaking = true;
  statusText.innerText = 'Nova konu≈üuyor...';
  speechSynthesis.speak(utter);
}

// stop
function stopSpeaking(){
  if(utter){
    speechSynthesis.cancel();
    addNovaMessage('(konu≈üma durduruldu)');
    utter = null;
    speaking = false;
    statusText.innerText = 'Konu≈üma durduruldu';
  }
}

// start listening (speech recognition)
function startListening(){
  chatMode = false;
  chatField.style.display = 'none';
  // create recognition
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!Recognition){
    alert('Tarayƒ±cƒ±nƒ±zda SpeechRecognition desteklenmiyor.');
    return;
  }
  const rec = new Recognition();
  rec.lang = 'tr-TR';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  try {
    rec.start();
    statusText.innerText = 'Dinleniyor...';
  } catch(e){
    console.error(e);
  }
  rec.onresult = (ev) => {
    const komut = ev.results[0][0].transcript.toLowerCase();
    addUserMessage(komut);
    processCommand(komut);
  }
  rec.onerror = (ev) => {
    statusText.innerText = 'Dinleme hatasƒ±';
    console.error(ev);
  }
  rec.onend = () => {
    if(!speaking) statusText.innerText = 'Hazƒ±r ‚Äî s√∂yle bir ≈üey s√∂yle';
  }
}

// chat mode toggle
function toggleChat(){
  chatMode = !chatMode;
  chatField.style.display = chatMode ? 'block' : 'none';
  if(chatMode) chatField.focus();
}

// send chat
function sendChat(){
  const txt = chatField.value.trim();
  if(!txt) return;
  addUserMessage(txt);
  chatField.value = '';
  processCommand(txt);
}

// processCommand: handle special commands locally, otherwise call backend/fallback
async function processCommand(komut){
  // local special commands
  if(komut.includes('sen kimsin')){
    speak('Ben Nova, Metehan tarafƒ±ndan geli≈ütirildim!');
    return;
  }
  if(komut === 'nova' || komut.includes('nova ') ){
    speak('Efendim?');
    return;
  }
  if(komut.includes('temizle ge√ßmi≈üi')){ clearHistory(); speak('Ge√ßmi≈ü temizlendi'); return; }

  // try backend
  statusText.innerText = 'AI ile konu≈üuluyor...';
  if(useBackend){
    try {
      const res = await fetch(BACKEND_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message: komut})
      });
      if(!res.ok) throw new Error('backend hata');
      const data = await res.json();
      const text = data.response || '(bo≈ü cevap)';
      speak(text);
      BACKEND_STATUS.innerText = '√áalƒ±≈üƒ±yor';
      return;
    } catch(err){
      console.warn('backend error', err);
      BACKEND_STATUS.innerText = 'Ula≈üƒ±lamƒ±yor';
      // fallthrough to local
    }
  }
  // fallback local response
  const pick = fallbackResponses[Math.floor(Math.random()*fallbackResponses.length)];
  speak(pick);
  statusText.innerText = '√áevrimdƒ±≈üƒ± mod (fallback)';
}

// backend check (ping)
async function checkBackend(){
  if(!BACKEND_URL) { useBackend = false; BACKEND_STATUS.innerText = 'Yok'; return; }
  try {
    const res = await fetch(BACKEND_URL, {
      method:'OPTIONS'
    });
    useBackend = res.ok;
    BACKEND_STATUS.innerText = useBackend ? '√áalƒ±≈üƒ±yor' : 'Ula≈üƒ±lamƒ±yor';
  } catch(e){
    useBackend = false;
    BACKEND_STATUS.innerText = 'Ula≈üƒ±lamƒ±yor';
  }
}

// visualizer
function drawVis(){
  ctx.clearRect(0,0,vis.width,vis.height);
  const w = vis.width, h = vis.height;
  // background rings
  const cx = w/2, cy = h/2;
  // pulsating circle based on speaking
  const t = Date.now() * 0.002;
  const base = 40 + (speaking ? Math.abs(Math.sin(t))*35 : 0);
  for(let i=0;i<6;i++){
    ctx.beginPath();
    ctx.arc(cx, cy, base + i*30, 0, Math.PI*2);
    const alpha = 0.06 - i*0.008;
    ctx.strokeStyle = `rgba(0,212,255,${alpha})`;
    ctx.lineWidth = 2;
    ctx.stroke();
  }
  // rotating rays
  for(let i=0;i<60;i++){
    const ang = (i/60)*Math.PI*2 + t*0.6;
    const len = (i%5===0 ? 12 : 6) + (speaking ? Math.random()*18 : 0);
    const sx = cx + Math.cos(ang)*(base+140);
    const sy = cy + Math.sin(ang)*(base+140);
    ctx.beginPath();
    ctx.moveTo(sx,sy);
    ctx.lineTo(sx + Math.cos(ang)*len, sy + Math.sin(ang)*len);
    ctx.strokeStyle = `rgba(0,212,255,0.05)`;
    ctx.stroke();
  }
  animationId = requestAnimationFrame(drawVis);
}
drawVis();

// initial backend check
checkBackend();

// expose some functions to console for quick testing
window.nova = {speak, stopSpeaking, processCommand, checkBackend};
</script>
</body>
</html>
